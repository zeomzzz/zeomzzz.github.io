---
title:  "[ìë°” ORM í‘œì¤€ JPA í”„ë¡œê·¸ë˜ë° - ê¸°ë³¸í¸] 03ê°•. ì˜ì†ì„± ê´€ë¦¬ - ë‚´ë¶€ ë™ì‘ ë°©ì‹"
excerpt: ""

categories:
  - JPA
tags:
  - [Framework, Lecture, JPA]

toc: true
toc_sticky: true
 
date: 2023-06-08
last_modified_at: 2023-06-08
---

<br>

# **03ê°•. ì˜ì†ì„± ê´€ë¦¬ - ë‚´ë¶€ ë™ì‘ ë°©ì‹**

<br>

## **1. ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸**

<br>

### **JPAì—ì„œ ê°€ì¥ ì¤‘ìš”í•œ 2ê°€ì§€**

<br>

- ê°ì²´ì™€ ê´€ê³„í˜• ë°ì´í„°ë² ì´ìŠ¤ ë§¤í•‘í•˜ê¸° (Object Relational Mapping) (ì •ì )
- ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ (ë™ì‘ ë©”ì»¤ë‹ˆì¦˜)

<br>
<br>

### **ì—”í‹°í‹° ë§¤ë‹ˆì € íŒ©í† ë¦¬ì™€ ì—”í‹°í‹° ë§¤ë‹ˆì €**

<br>

![]({{ site.url }}{{ site.baseurl }}/assets/images/jpa/lecture/orm/03/230608jpalecture0301.png ){: .align-center}

- EntityManagerFactory í†µí•´ì„œ ìš”ì²­ì´ ì˜¬ ë•Œë§ˆë‹¤ EntityManagerë¥¼ ë§Œë“¦
- EntityManageëŠ” ë‚´ë¶€ì ìœ¼ë¡œ DB Connectionì„ ì‚¬ìš©í•´ì„œ DBë¥¼ ì‚¬ìš©

<br>
<br>

### **ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸**

<br>

- JPAë¥¼ ì´í•´í•˜ëŠ”ë° ê°€ì¥ ì¤‘ìš”í•œ ìš©ì–´
- ì—”í‹°í‹°ë¥¼ ì˜êµ¬ ì €ì¥í•˜ëŠ” í™˜ê²½
- ì—”í‹°í‹° ë§¤ë‹ˆì €ë¥¼ í†µí•´ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì ‘ê·¼
    - ì—”í‹°í‹° ë§¤ë‹ˆì €ë¥¼ ìƒì„±í•˜ë©´ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¼ëŠ” ê³µê°„ì´ ìƒê¹€
- `EntityManager.persist(entity);`
    - EntityManagerì—ì„œ persistí˜¸ì¶œí•´ì„œ entityë¥¼ ë„£ìœ¼ë©´ DBì— ì €ì¥í•˜ëŠ” ê²ƒ.. ì²˜ëŸ¼ ë³´ì´ì§€ë§Œ
    - ì‹¤ì œë¡œëŠ” ..
        - ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¥¼ í†µí•´ì„œ Entityë¥¼ ì˜ì†í™”
        - persist : Entityë¥¼ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì €ì¥ (DBì— ì €ì¥ X)
- J2SE í™˜ê²½ : ì—”í‹°í‹° ë§¤ë‹ˆì €ì™€ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ê°€ 1:1
    
    J2EE, ìŠ¤í”„ë§ í”„ë ˆì„ì›Œí¬ ê°™ì€ ì»¨í…Œì´ë„ˆ í™˜ê²½ : ì—”í‹°í‹° ë§¤ë‹ˆì €ì™€ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ê°€ N:1
    
<br>
<br>

### **ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì˜ ì´ì **

<br>

- ì• í”Œë¦¬ì¼€ì´ì…˜ê³¼ DB ì‚¬ì´ì— ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¼ëŠ” ì¤‘ê°„ ê³„ì¸µ ì¡´ì¬
- ì¤‘ê°„ ê³„ì¸µì´ ìˆë‹¤ëŠ” ì ìœ¼ë¡œ ì¸í•´ ì¥ì ì„ ì–»ì„ ìˆ˜ ìˆìŒ (ex. ë²„í¼ë§, ìºì‹± ë“±)

<br>

#### **1) ì—”í‹°í‹° ì¡°íšŒ - 1ì°¨ ìºì‹œ**

<br>

![]({{ site.url }}{{ site.baseurl }}/assets/images/jpa/lecture/orm/03/230608jpalecture0302.png ){: .align-center}

- ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ ë‚´ë¶€ì— 1ì°¨ ìºì‹œ ê°€ì§€ê³  ìˆìŒ
- 1ì°¨ ìºì‹œ : Key(@Id), ê°’(Entity ìì²´)ìœ¼ë¡œ ì´ë£¨ì–´ì§
    
    ex. Key : member1, ê°’ : persistí•œ member ìì²´
    
    ```java
    //ì—”í‹°í‹°ë¥¼ ìƒì„±í•œ ìƒíƒœ(ë¹„ì˜ì†)
    Member member = new Member();
    member.setId("member1");
    member.setUsername("íšŒì›1");
    
    //ì—”í‹°í‹°ë¥¼ ì˜ì†
    em.persist(member);
    ```
    
- ì¡°íšŒí•  ë•Œì— 1ì°¨ ìºì‹œ í™•ì¸ í›„, ì—†ëŠ” ê²½ìš°ì— DBë¡œ ì¿¼ë¦¬ë¥¼ ë³´ëƒ„
    
    ex. 1ì°¨ ìºì‹œì—ì„œ ì¡°íšŒ
    
    ```java
    Member member = new Member();
    member.setId("member1");
    member.setUsername("íšŒì›1");
    
    //1ì°¨ ìºì‹œì— ì €ì¥ë¨ (jpaëŠ” ì—”í‹°í‹° ì¡°íšŒí•˜ë©´ ë¬´ì¡°ê±´ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì˜¬ë¦¼)
    em.persist(member);
    
    //1ì°¨ ìºì‹œì—ì„œ ì¡°íšŒ
    Member findMember = em.find(Member.class, "member1");
    ```
    
    ![]({{ site.url }}{{ site.baseurl }}/assets/images/jpa/lecture/orm/03/230608jpalecture0303.png ){: .align-center}
    
    ex. DBì—ì„œ ì¡°íšŒ
    
    ```java
    Member findMember2 = em.find(Member.class, "member2");
    ```
    
    ![]({{ site.url }}{{ site.baseurl }}/assets/images/jpa/lecture/orm/03/230608jpalecture0304.png ){: .align-center}
    
    - ê³¼ì • : 1ì°¨ ìºì‹œì—ì„œ ì°¾ì•„ë´„ -> member2ëŠ” 1ì°¨ ìºì‹œì— ì—†ì—ˆìŒ -> JPAê°€ DBì—ì„œ ì¡°íšŒ -> DBì˜ member2ë¥¼ 2ì°¨ ìºì‹œì— ì €ì¥ . ê·¸ë¦¬ê³  member2ë¥¼ ë°˜í™˜ -> ì´í›„ì— member2ë¥¼ ì¡°íšŒí•˜ë©´ 1ì°¨ ìºì‹œì—ì„œ ì°¾ì•„ë´„

- ê·¸ëŸ¬ë‚˜, íŠ¸ëœì­ì…˜ ëë‚  ë•Œ 1ì°¨ ìºì‹œë„ ì‚¬ë¼ì ¸ì„œ í¬ê²Œ ë„ì›€ì´ ë˜ì§€ëŠ” ì•ŠìŒ


> ğŸ’¡ ì „ì²´ì—ì„œ ê³µìœ í•˜ëŠ” ìºì‹œ : 2ì°¨ ìºì‹œ



- ì°¸ê³  ì½”ë“œ : 1ì°¨ ìºì‹œì—ì„œ ì¡°íšŒ
    
    ```java
    public class JpaMain {
    
        public static void main(String[] args) {
            
            // ìƒëµ
    
            try {
    
                // ë¹„ì˜ì†
                Member member = new Member();
                member.setId(101L);
                member.setName("HelloJPA");
    
                // ì˜ì†
                System.out.println("=== BEFORE ===");
                em.persist(member);
                System.out.println("=== AFTER ===");
    
                Member findMember = em.find(Member.class, 101L);
    
                System.out.println("findMember.id = " + findMember.getId());
                System.out.println("findMember.name = " + findMember.getName());
    
                tx.commit();
            } 
            
            // ìƒëµ

        }
    }
    ```
    
    ì‹¤í–‰ê²°ê³¼ : Select ì¿¼ë¦¬ê°€ ë‚˜ê°€ì§€ ì•Šì•˜ëŠ”ë°ë„ 1ì°¨ ìºì‹œë¥¼ ì¡°íšŒí•´ì„œ ê²°ê³¼ ì¶œë ¥
    
    ```java
    === BEFORE ===
    === AFTER ===
    findMember.id = 101
    findMember.name = HelloJPA
    Hibernate: 
        /* insert hellojpa.Member
            */ insert 
            into
                Member
                (name, id) 
            values
                (?, ?)
    ```
    

> ğŸ’¡ **ë™ì¼í•œ ì¡°íšŒë¥¼ ë‘ ë²ˆ í•˜ë©´?**
> 
> ```java
> public class JpaMain {
>
>     public static void main(String[] args) {
>    
>         // ìƒëµ
>
>         try {
>
>             Member findMember1 = em.find(Member.class, 101L);
>             Member findMember2 = em.find(Member.class, 101L);
>
>             tx.commit();
>         } 
>
>        // ìƒëµ
>
>    }
> }
> ```
>
> ì‹¤í–‰ê²°ê³¼ : Select ì¿¼ë¦¬ í•œ ë²ˆë§Œ ë‚˜ê°!
>
> ```java
> Hibernate: 
>     select
>         member0_.id as id1_0_0_,
>         member0_.name as name2_0_0_ 
>     from
>         Member member0_ 
>     where
>         member0_.id=?
> ```
>
> - ì²˜ìŒì— dbì—ì„œ ê°€ì ¸ì™€ì„œ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì˜¬ë¦¼
> - ë‘ë²ˆì§¸ findì—ì„œ ë˜‘ê°™ì€ ê²ƒì„ ì¡°íšŒ -> 1ì°¨ ìºì‹œë¶€í„° ì°¾ê³ , ì°¾ì€ ê²ƒì„ ë°˜í™˜

<br>
<br>

#### **2) ì˜ì† ì—”í‹°í‹°ì˜ ë™ì¼ì„± ë³´ì¥**

<br>

```java
Member a = em.find(Member.class, "member1");
Member b = em.find(Member.class, "member1");

System.out.println(a == b); //ë™ì¼ì„± ë¹„êµ true
```

- 1ì°¨ ìºì‹œë¡œ ë°˜ë³µ ê°€ëŠ¥í•œ ì½ê¸°(REPEATABLE READ) ë“±ê¸‰ì˜ íŠ¸ëœì­ì…˜ ê²©ë¦¬ ìˆ˜ì¤€ì„ ë°ì´í„°ë² ì´ìŠ¤ê°€ ì•„ë‹Œ ì• í”Œë¦¬ì¼€ì´ì…˜ ì°¨ì›ì—ì„œ ì œê³µ
- ì¦‰, 1ì°¨ ìºì‹œê°€ ìˆê¸° ë•Œë¬¸ì— ê°€ëŠ¥

ex.

```java
public class JpaMain {

    public static void main(String[] args) {

        // ìƒëµ

        try {

            Member findMember1 = em.find(Member.class, 101L);
            Member findMember2 = em.find(Member.class, 101L);

            System.out.println("result = " + (findMember1 == findMember2));

            tx.commit();
        } 
        
        // ìƒëµ

    }
}
```

ê²°ê³¼

```java
Hibernate: 
    select
        member0_.id as id1_0_0_,
        member0_.name as name2_0_0_ 
    from
        Member member0_ 
    where
        member0_.id=?
result = true
```

<br>
<br>

#### **3) ì—”í‹°í‹° ë“±ë¡ - íŠ¸ëœì­ì…˜ì„ ì§€ì›í•˜ëŠ” ì“°ê¸° ì§€ì—°**

<br>

- ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì—ëŠ” 1ì°¨ ìºì‹œ ì™¸ì— ì“°ê¸° ì§€ì—° SQL ì €ì¥ì†Œê°€ ìˆìŒ. ì“°ê¸° ì§€ì—° SQL ì €ì¥ì†Œë¥¼ ì´ìš©

```java
EntityManager em = emf.createEntityManager();
EntityTransaction transaction = em.getTransaction();
//ì—”í‹°í‹° ë§¤ë‹ˆì €ëŠ” ë°ì´í„° ë³€ê²½ì‹œ íŠ¸ëœì­ì…˜ì„ ì‹œì‘í•´ì•¼ í•¨
transaction.begin(); // [íŠ¸ëœì­ì…˜] ì‹œì‘

em.persist(memberA);
em.persist(memberB);
//ì—¬ê¸°ê¹Œì§€ INSERT SQLì„ ë°ì´í„°ë² ì´ìŠ¤ì— ë³´ë‚´ì§€ ì•ŠìŒ (ì“°ê¸° ì§€ì—° SQL ì €ì¥ì†Œì— ìŒ“ìŒ)

//ì»¤ë°‹í•˜ëŠ” ìˆœê°„ ë°ì´í„°ë² ì´ìŠ¤ì— INSERT SQLì„ ë³´ëƒ„
transaction.commit(); // [íŠ¸ëœì­ì…˜] ì»¤ë°‹
```

- ë‚´ë¶€ ë©”ì»¤ë‹ˆì¦˜
    - `em.persist(memberA);` : memberAê°€ 1ì°¨ ìºì‹œì— ë“¤ì–´ê°€ê³ , ë™ì‹œì— JPAê°€ ì—”í‹°í‹° ë¶„ì„í•´ì„œ insert ì¿¼ë¦¬ ìƒì„± -> ì¿¼ë¦¬ë¥¼ ì“°ê¸° ì§€ì—° SQL ì €ì¥ì†Œì— ìŒ“ìŒ (ì•„ì§ DBì— ë„£ì§€ X)
        
        ![]({{ site.url }}{{ site.baseurl }}/assets/images/jpa/lecture/orm/03/230608jpalecture0305.png ){: .align-center}
        
    - `em.persist(memberB);` : 1ì°¨ ìºì‹œì— memberB ë„£ìœ¼ë©´ì„œ insert ì¿¼ë¦¬ ìƒì„±í•˜ì—¬ ì“°ê¸° ì§€ì—° SQL ì €ì¥ì†Œì— ìŒ“ìŒ(DBì— ë„£ì§€ X)
        
        â‡’ ì“°ê¸° ì§€ì—° SQL : insert A, B ëª¨ë‘ ìŒ“ì—¬ ìˆìŒ
        
        ![]({{ site.url }}{{ site.baseurl }}/assets/images/jpa/lecture/orm/03/230608jpalecture0306.png ){: .align-center}
        
    - `transaction.commit();`
        - ì“°ê¸° ì§€ì—° SQL ì €ì¥ì†Œì— ìŒ“ì—¬ìˆë˜ ì¿¼ë¦¬ê°€ flushë˜ë©´ì„œ ë‚˜ê°
        - ì‹¤ì œ database transactionì´ commitë¨
        
        ![]({{ site.url }}{{ site.baseurl }}/assets/images/jpa/lecture/orm/03/230608jpalecture0307.png ){: .align-center}
        

ex. 

Member ê°ì²´ì— ìƒì„±ì

```java
@Entity
public class Member {

    @Id // PK
    private long id;
    private String name;

    // ìƒì„±ì (ê¸°ë³¸ ìƒì„±ì ê¼­!!)
    public Member() {
    }
    public Member(long id, String name) {
        this.id = id;
        this.name = name;
    }

    // getter, setter
    // ìƒëµ

}
```

main

```java
public class JpaMain {

    public static void main(String[] args) {

        // ìƒëµ

        try {

            Member member1 = new Member(150L, "A");
            Member member2 = new Member(160L, "B");

            em.persist(member1);
            em.persist(member2);

            System.out.println("===================");

            tx.commit();
        } 
        
        // ìƒëµ

    }
}
```

ì‹¤í–‰ ê²°ê³¼ : ======= ì´í›„ì— ì¿¼ë¦¬ê°€ ë‚˜ê°(commit ì‹œì ì—)

```java
===================
Hibernate: 
    /* insert hellojpa.Member
        */ insert 
        into
            Member
            (name, id) 
        values
            (?, ?)
Hibernate: 
    /* insert hellojpa.Member
        */ insert 
        into
            Member
            (name, id) 
        values
            (?, ?)
```


> ğŸ’¡ **ë²„í¼ë§ ê¸°ëŠ¥**
> 
> - hibernateì˜ ì˜µì…˜ìœ¼ë¡œ : persistence.xmlì—ì„œ `<property name="hibernate.jdbc.batch_size" value="10"/>`
> - sizeë§Œí¼ ëª¨ì•„ì„œ ë°ì´í„°ë² ì´ìŠ¤ì— í•œë°©ì— ë„¤íŠ¸ì›Œí¬ë¡œ ì¿¼ë¦¬ ë³´ë‚´ê³  DBë¥¼ ì»¤ë°‹

<br>
<br>

#### **4) ì—”í‹°í‹° ìˆ˜ì • : ë³€ê²½ ê°ì§€ (Dirty Checking)**

<br>

- ìë°” ì»¬ë ‰ì…˜ì²˜ëŸ¼ setterë¡œ ê°’ì„ ë³€ê²½í•´ì£¼ëŠ” persistí•˜ì§€ ì•Šì•„ë„ ë³€ê²½ì´ DBì— ë°˜ì˜ë¨ : Dirty Checking ë•ë¶„
    
    ```java
    EntityManager em = emf.createEntityManager();
    EntityTransaction transaction = em.getTransaction();
    transaction.begin(); // [íŠ¸ëœì­ì…˜] ì‹œì‘
    
    // ì˜ì† ì—”í‹°í‹° ì¡°íšŒ
    Member memberA = em.find(Member.class, "memberA");
    
    // ì˜ì† ì—”í‹°í‹° ë°ì´í„° ìˆ˜ì •
    memberA.setUsername("hi");
    memberA.setAge(10);
    
    //em.update(member) ì´ëŸ° ì½”ë“œê°€ ìˆì–´ì•¼ í•˜ì§€ ì•Šì„ê¹Œ? X
    
    transaction.commit(); // [íŠ¸ëœì­ì…˜] ì»¤ë°‹
    ```
    
- Dirty Checking
    
    ![]({{ site.url }}{{ site.baseurl }}/assets/images/jpa/lecture/orm/03/230608jpalecture0308.png ){: .align-center}
    
    1. JPAë¥¼ ì»¤ë°‹í•˜ë©´ ë‚´ë¶€ì ìœ¼ë¡œ flush í˜¸ì¶œ
    2. JPAê°€ ì—”í‹°í‹°ì™€ ìŠ¤ëƒ…ìƒ·ì„ ë¹„êµ
        
        
        > ğŸ’¡ **ìŠ¤ëƒ…ìƒ·**
        > 
        > - 1ì°¨ ìºì‹œì—ëŠ” @Id, Entity ì™¸ì— ìŠ¤ëƒ…ìƒ·ì´ ìˆìŒ.
        > - ìŠ¤ëƒ…ìƒ· : ê°’ì„ ì½ì–´ì˜¨ ì‹œì , ìµœì´ˆ ì‹œì ì˜ ìƒíƒœë¥¼ ìŠ¤ëƒ…ìƒ·ìœ¼ë¡œ ì €ì¥
        
    3. ë³€ê²½ ì‚¬í•­ì´ ìˆìœ¼ë©´ Update ì¿¼ë¦¬ë¥¼ ì“°ê¸°ì§€ì—° ì €ì¥ì†Œì— ë§Œë“¤ì–´ë‘ê³  DBì— ë°˜ì˜

ex. 

```java
public class JpaMain {

    public static void main(String[] args) {
        
        // ìƒëµ

        try {

            Member member = em.find(Member.class, 150L);
            member.setName("ZZZZ");

//            em.persist(member); // í•˜ì§€ ì•ŠìŒ!!!

            System.out.println("===============");

            tx.commit();
        } 
        
        // ìƒëµ

    }
}
```

ì‹¤í–‰ ê²°ê³¼

```java
Hibernate: 
    select
        member0_.id as id1_0_0_,
        member0_.name as name2_0_0_ 
    from
        Member member0_ 
    where
        member0_.id=?
===============
Hibernate: 
    /* update
        hellojpa.Member */ update
            Member 
        set
            name=? 
        where
            id=?
```

<br>
<br>

### **5) ì—”í‹°í‹° ì‚­ì œ**

<br>

```java
//ì‚­ì œ ëŒ€ìƒ ì—”í‹°í‹° ì¡°íšŒ
Member memberA = em.find(Member.class, â€œmemberA");

em.remove(memberA); //ì—”í‹°í‹° ì‚­ì œ. transaction commit ì‹œì ì— deleteê°€ ë‚˜ê°
```

<br>
<br>

### **í”ŒëŸ¬ì‹œ**

<br>

- DB commití•  ë•Œ ë°œìƒ
- ìŒ“ì•„ë‘” SQL ì¿¼ë¦¬ë“¤ì´ ë°ì´í„°ë² ì´ìŠ¤ë¡œ ë‚˜ê°€ì„œ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì˜ ë³€ê²½ë‚´ìš©ì„ ë°ì´í„°ë² ì´ìŠ¤ì— ë°˜ì˜
- ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì˜ ë³€ê²½ì‚¬í•­ê³¼ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ë§ì¶”ëŠ” ì‘ì—… (ë™ê¸°í™”)
- íŠ¸ëœì­ì…˜ì´ë¼ëŠ” ì‘ì—… ë‹¨ìœ„ê°€ ì¤‘ìš” -> ì»¤ë°‹ ì§ì „ì—ë§Œ ë™ê¸°í™”í•˜ë©´ ë¨
    
    >ğŸ’¡ ë™ì‹œì„±ì— ëŒ€í•œ ê²ƒì€ ë‹¤ ë°ì´í„°ë² ì´ìŠ¤ ì»¤ë°‹ì— ìœ„ì„í•´ì„œ ì‚¬ìš©
    
    
- í”ŒëŸ¬ì‹œê°€ ë°œìƒí•˜ë©´..
    - ë³€ê²½ ê°ì§€
    - ìˆ˜ì •ëœ ì—”í‹°í‹° ì“°ê¸° ì§€ì—° SQL ì €ì¥ì†Œì— ë“±ë¡
    - ì“°ê¸° ì§€ì—° SQL ì €ì¥ì†Œì˜ ì¿¼ë¦¬ë¥¼ ë°ì´í„°ë² ì´ìŠ¤ì— ì „ì†¡ (ë“±ë¡, ìˆ˜ì •, ì‚­ì œ ì¿¼ë¦¬)

>ğŸ’¡ flush ë°œìƒí•  ë•Œ, db transactionì´ commit ë˜ëŠ” ê²ƒì´ ì•„ë‹ˆê³ , ë³´ë‚´ê³  database commit

<br>
<br>

### **ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ í”ŒëŸ¬ì‹œ ë°©ë²•**

<br>

- ë°©ë²• 1. `em.flush()` - ì§ì ‘ í˜¸ì¶œ
    
    ex.
    
    ```java
    public class JpaMain {
    
        public static void main(String[] args) {
            
            // ìƒëµ
    
            try {
    
                Member member =  new Member(200L, "member200");
                em.persist(member);
    
                // íŠ¸ëœì­ì…˜ commit ë˜ê¸° ì „ê¹Œì§€ëŠ” ì¿¼ë¦¬ë¥¼ ë³¼ ìˆ˜ ì—†ìŒ
                // ì¿¼ë¦¬ë¥¼ ë¯¸ë¦¬ ë°˜ì˜í•˜ê³  ì‹¶ê±°ë‚˜ ì¿¼ë¦¬ ë³´ê³  ì‹¶ìœ¼ë©´ flushë¡œ ê°•ì œë¡œ í˜¸ì¶œ
                em.flush(); // insert ì¿¼ë¦¬ê°€ ì´ ì‹œì ì— ë‚˜ê°
    
                System.out.println("==================");
    
                tx.commit();
            } 
            
            // ìƒëµ

        }
    }
    ```
    
    ì‹¤í–‰ê²°ê³¼
    
    ```java
    Hibernate: 
        /* insert hellojpa.Member
            */ insert 
            into
                Member
                (name, id) 
            values
                (?, ?)
    ==================
    ```
    
    - ==== ì „ì— insert ì¿¼ë¦¬ê°€ í˜¸ì¶œë¨
    - em.persistí•œ ì‹œì ì—ì„œ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ë‹´ê¸°ê³  flush í•´ë²„ë¦¬ë‹ˆê¹Œ DBì— ë°˜ì˜ë¨
    
    > ğŸ’¡ **flushí•˜ë©´ 1ì°¨ ìºì‹œê°€ ë‹¤ ì§€ì›Œì§ˆê¹Œ? -> X**
    >
    > - flushëŠ” 1ì°¨ ìºì‹œ ì§€ìš°ëŠ” ê²ƒì´ ì•„ë‹ˆê³  ë³€ê²½ ê°ì§€ê°€ ì¼ì–´ë‚˜ê³  ì§€ì—° SQL ì €ì¥ì†Œì— ìˆëŠ”ê²ƒë“¤ì´ DBì— ë°˜ì˜ë˜ëŠ” ê³¼ì •
    
- ë°©ë²• 2. íŠ¸ëœì­ì…˜ ì»¤ë°‹ - í”ŒëŸ¬ì‹œ ìë™ í˜¸ì¶œ
- ë°©ë²• 3. JPQL ì¿¼ë¦¬ ì‹¤í–‰ - í”ŒëŸ¬ì‹œ ìë™ í˜¸ì¶œ
    
    > ğŸ’¡ JPQL ì¿¼ë¦¬ ì‹¤í–‰í–ˆì„ ë•Œ Flush ì™œ ìë™ìœ¼ë¡œ í˜¸ì¶œë ê¹Œ?
    >
    > ```java
    > em.persist(memberA);
    > em.persist(memberB);
    > em.persist(memberC);
    > 
    > //ì¤‘ê°„ì— JPQL ì‹¤í–‰ -> memberA, B, C ì¡°íšŒë˜ì§€ ì•ŠìŒ. insert ì¿¼ë¦¬ ìì²´ê°€ ì•ˆë‚ ì•„ê°
    > // JPQLì€ sqlë¡œ ë²ˆì—­ë˜ì„œ ì‹¤í–‰ë˜ëŠ”ë° ê°€ì ¸ì˜¬ê²Œ ì—†ìŒ. ì˜ëª»í•˜ë©´ ë¬¸ì œ ë°œìƒ!!
    > // ì´ë¥¼ ë°œìƒí•˜ê³ ì jpql ì‹¤í–‰í•  ë•Œ ë¬´ì¡°ê±´ flush
    > query = em.createQuery("select m from Member m", Member.class);
    > List<Member> members= query.getResultList();
    > ```

<br>
<br>

### **í”ŒëŸ¬ì‹œ ëª¨ë“œ ì˜µì…˜**

<br>

```java
em.setFlushMode(FlushModeType.COMMIT)
```

| ì˜µì…˜ | ìƒì„¸ |
| --- | --- |
| FlushModeType.AUTO | ì»¤ë°‹ì´ë‚˜ ì¿¼ë¦¬ë¥¼ ì‹¤í–‰í•  ë•Œ í”ŒëŸ¬ì‹œ (ê¸°ë³¸ê°’) |
| FlushModeType.COMMIT | ì»¤ë°‹í•  ë•Œë§Œ í”ŒëŸ¬ì‹œ (ì¿¼ë¦¬ ì‹¤í–‰í•  ë•ŒëŠ” flush X) |

- auto ì‚¬ìš© ê¶Œì¥

<br>
<br>

## **2. ì—”í‹°í‹°ì˜ ìƒëª…ì£¼ê¸°**

<br>

### **ì—”í‹°í‹°ì˜ ìƒëª…ì£¼ê¸°**

<br>

| ìƒëª…ì£¼ê¸° | ìƒì„¸ |
| --- | --- |
| ë¹„ì˜ì† (new/transient) | - ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì™€ ì „í˜€ ê´€ê³„ê°€ ì—†ëŠ” ìƒˆë¡œìš´ ìƒíƒœ <br>- ìµœì´ˆì˜ ë©¤ë²„ ê°ì²´ë¥¼ ìƒì„±í•œ ìƒíƒœ |
| ì˜ì† (managed) | - ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ê´€ë¦¬ë˜ëŠ” ìƒíƒœ <br> - entityManager.persistí•˜ë©´ ì˜ì†ìƒíƒœê°€ ë¨ |
| ì¤€ì˜ì† (detached) | - ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì €ì¥ë˜ì—ˆë‹¤ê°€ ë¶„ë¦¬ëœ ìƒíƒœ |
| ì‚­ì œ (removed) | - ì‚­ì œëœ ìƒíƒœ |

![]({{ site.url }}{{ site.baseurl }}/assets/images/jpa/lecture/orm/03/230608jpalecture0309.png ){: .align-center}

<br>

#### **1) ë¹„ì˜ì†**

<br>

![]({{ site.url }}{{ site.baseurl }}/assets/images/jpa/lecture/orm/03/230608jpalecture0310.png ){: .align-center}

```java
//ê°ì²´ë¥¼ ìƒì„±í•œ ìƒíƒœ(ë¹„ì˜ì†)
Member member = new Member();
member.setId("member1");
member.setUsername("íšŒì›1");
```

- member ê°ì²´ë¥¼ ìƒì„±í•˜ì—¬ ì„¸íŒ…ë§Œ í•˜ê³  entityManagerì—ëŠ” ë„£ì§€ ì•Šì€ ìƒíƒœ
- JPAì™€ ìƒê´€ ì—†ëŠ” ìƒíƒœ

<br>
<br>

#### **2) ì˜ì†**

<br>

![]({{ site.url }}{{ site.baseurl }}/assets/images/jpa/lecture/orm/03/230608jpalecture0311.png ){: .align-center}

```java
//ê°ì²´ë¥¼ ìƒì„±í•œ ìƒíƒœ(ë¹„ì˜ì†)
Member member = new Member();
member.setId("member1");
member.setUsername(â€œíšŒì›1â€);

EntityManager em = emf.createEntityManager();
em.getTransaction().begin();

//ê°ì²´ë¥¼ ì €ì¥í•œ ìƒíƒœ(ì˜ì†)
em.persist(member);
```

- ì˜ì†ìƒíƒœê°€ ë˜ëŠ” ê²½ìš°
    1. persistí•˜ì—¬ entityManager ì•ˆì˜ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— member ê°ì²´ ë“¤ì–´ê°€ë©´ì„œ ì˜ì† ìƒíƒœê°€ ë¨
    2. em.findí•´ì„œ ê°€ì ¸ì™”ëŠ”ë° 1ì°¨ ìºì‹œì— ì—†ìœ¼ë©´ dbì—ì„œ ê°€ì ¸ì™€ì„œ 1ì°¨ ìºì‹œì— ì˜¬ë¦¼(= ì˜ì† ìƒíƒœ)
- entityManager ì•ˆì˜ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì˜í•´ ê´€ë¦¬ë¨
- ì´ë•ŒëŠ” DBì— ì €ì¥ë˜ì§€ ì•ŠìŒ (INSERT ì¿¼ë¦¬ëŠ” commit í•  ë•Œ ë‚˜ê°

<br>

#### **3) ì¤€ì˜ì†**

<br>

```java
//ê°ì²´ë¥¼ ì‚­ì œí•œ ìƒíƒœ(ì‚­ì œ)
em.remove(member);
```

- ì˜ì† ìƒíƒœì˜€ë˜ entityê°€ ì•„ë¬´ ê´€ê³„ ì—†ì–´ì§ (ì˜ì† &rarr; ì¤€ì˜ì†)
- ì˜ì† ìƒíƒœì˜ ì—”í‹°í‹°ê°€ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì—ì„œ ë¶„ë¦¬(detached)
- ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ê°€ ì œê³µí•˜ëŠ” ê¸°ëŠ¥ì„ ì‚¬ìš© ëª»í•¨ (Dirty Checking ë“±)
- ì¤€ì˜ì† ìƒíƒœë¡œ ë§Œë“œëŠ” ë°©ë²•
    
    
    | ë°©ë²• | ìƒì„¸ |
    | --- | --- |
    | em.detach(entity) | íŠ¹ì • ì—”í‹°í‹°ë§Œ ì¤€ì˜ì† ìƒíƒœë¡œ ì „í™˜ |
    | em.clear() | ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¥¼ ì™„ì „íˆ ì´ˆê¸°í™” |
    | em.close() | ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¥¼ ì¢…ë£Œ |
    
    ex. detach
    
    ```java
    public class JpaMain {
    
        public static void main(String[] args) {
            
            // ìƒëµ
    
            try {
    
                Member member = em.find(Member.class, 150L); // ì´ê±° í•˜ë©´ memberëŠ” ì˜ì† ìƒíƒœ
                member.setName("AAAA");
    
                // ë” ì´ìƒ ì˜ì†ì„±ì»¨í…ìŠ¤íŠ¸ì—ì„œ ê´€ë¦¬í•˜ê¸° ì‹«ìŒ
                em.detach(member);
                // JPAì—ì„œ ê´€ë¦¬í•˜ì§€ ì•ŠìŒ. ê·¸ëŸ¬ë©´ íŠ¸ëœì­ì…˜ ì‹¤í–‰í•  ë•Œ ì•„ë¬´ì¼ë„ ì¼ì–´ë‚˜ì§€ ì•ŠìŒ
    
                System.out.println("=============");
    
                tx.commit();
            } 
            
            // ìƒëµ

        }
    }
    ```
    
    ì‹¤í–‰ê²°ê³¼ : detachë¶€í„° ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì—ì„œ ê´€ë¦¬í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ Selectë§Œ ì‹¤í–‰ë¨
    
    ```java
    Hibernate: 
        select
            member0_.id as id1_0_0_,
            member0_.name as name2_0_0_ 
        from
            Member member0_ 
        where
            member0_.id=?
    =============
    ```
    
    ex. clear
    
    ```java
    public class JpaMain {
    
        public static void main(String[] args) {
            
            // ìƒëµ
    
            try {
    
                Member member = em.find(Member.class, 150L); // -> member : ì˜ì† ìƒíƒœ
                member.setName("AAAA");
    
                em.clear(); // 1ì°¨ ìºì‹œ ë‹¤ ë‚ ë¦¼
    
                Member member2 = em.find(Member.class, 150L);
    
                System.out.println("=============");
    
                tx.commit();
            } 
            
            // ìƒëµ

        }
    }
    ```
    
    ì‹¤í–‰ê²°ê³¼ : Select -> 1ì°¨ ìºì‹œ ì§€ì›€ -> Select (ë‹¤ì‹œ DBì—ì„œ ê°€ì ¸ì˜´)
    
    ```java
    Hibernate: 
        select
            member0_.id as id1_0_0_,
            member0_.name as name2_0_0_ 
        from
            Member member0_ 
        where
            member0_.id=?
    Hibernate: 
        select
            member0_.id as id1_0_0_,
            member0_.name as name2_0_0_ 
        from
            Member member0_ 
        where
            member0_.id=?
    =============
    ```

<br>    

#### **4) ì‚­ì œ**

<br>

```java
//ê°ì²´ë¥¼ ì‚­ì œí•œ ìƒíƒœ(ì‚­ì œ)
em.remove(member);
```

- ì‹¤ì œ DB ì‚­ì œë¥¼ ìš”ì²­í•œ ìƒíƒœ