---
title:  "[ìë°” ORM í‘œì¤€ JPA í”„ë¡œê·¸ë˜ë° - ê¸°ë³¸í¸] 07ê°•. ê³ ê¸‰ ë§¤í•‘"
excerpt: "ìˆ˜ê°• ì¤‘"

categories:
  - JPA
tags:
  - [Framework, Lecture, JPA]

toc: true
toc_sticky: true
 
date: 2023-07-02
last_modified_at: 2023-07-02
---

<br>

# **07ê°•. ê³ ê¸‰ ë§¤í•‘**

<br>

# **1. ìƒì†ê´€ê³„ ë§¤í•‘**

<br>

## **ìƒì†ê´€ê³„ ë§¤í•‘**

<br>

- ìƒì†ê´€ê³„ ë§¤í•‘ : ê°ì²´ì˜ ìƒì†ê³¼ êµ¬ì¡°ì™€ DBì˜ ìŠˆí¼íƒ€ì… ì„œë¸Œíƒ€ì… ê´€ê³„ë¥¼ ë§¤í•‘
- ìŠˆí¼íƒ€ì… ì„œë¸Œíƒ€ì… ê´€ê³„ë¼ëŠ” ëª¨ë¸ë§ ê¸°ë²•ì´ ê°ì²´ ìƒì†ê³¼ ìœ ì‚¬ (ê´€ê³„í˜• DBëŠ” ìƒì† ê´€ê³„ ì—†ìŒ)
- ìŠˆí¼íƒ€ì… ì„œë¸Œíƒ€ì… ë…¼ë¦¬ ëª¨ë¸ì„ ì‹¤ì œ ë¬¼ë¦¬ ëª¨ë¸ë¡œ êµ¬í˜„í•˜ëŠ” ë°©ë²• (3ê°€ì§€)
    
    
    | ì „ëµ | ìƒì„¸ | Annotation |
    | --- | --- | --- |
    | ì¡°ì¸ ì „ëµ | ê°ê° í…Œì´ë¸”ë¡œ ë³€í™˜ | `@Inheritance(strategy=InheritanceType.JOINED)` |
    | ë‹¨ì¼ í…Œì´ë¸” ì „ëµ | í†µí•© í…Œì´ë¸”ë¡œ ë³€í™˜ (JPA ê¸°ë³¸ê°’) | `@Inheritance(strategy=InheritanceType.SINGLE_TABLE)` |
    | êµ¬í˜„ í´ë˜ìŠ¤ë§ˆë‹¤ í…Œì´ë¸” ì „ëµ | ì„œë¸Œíƒ€ì… í…Œì´ë¸”ë¡œ ì „ëµ<br>ì‚¬ìš©í•˜ì§€ ë§ ê²ƒ | `@Inheritance(strategy=InheritanceType.TABLE_PER_CLASS)` |
- ì£¼ìš” Annotation
    - `@Inheritance(strategy=InheritanceType.XXX)`
        
        
        | ì „ëµ | Typeëª… |
        | --- | --- |
        | ì¡°ì¸ ì „ëµ | JOINED |
        | ë‹¨ì¼ í…Œì´ë¸” ì „ëµ | SINGLE_TABLE |
        | êµ¬í˜„ í´ë˜ìŠ¤ë§ˆë‹¤ í…Œì´ë¸” ì „ëµ | TABLE_PER_CLASS |
    - `@DiscriminatorColumn(name=â€œDTYPEâ€)`
    - `@DiscriminatorValue(â€œXXXâ€)`

ex. 

![]({{ site.url }}{{ site.baseurl }}/assets/images/jpa/lecture/orm/07/01.png ){: .align-center}

- ê°ì²´ ì„¤ê³„ì‹œì— ê¸°ë³¸ì ìœ¼ë¡œ Itemì´ë¼ëŠ” abstract classë¥¼ Album, Movie, Bookì´ ìƒì†ë°›ë„ë¡ ì„¤ê³„
    - Itemë§Œ ë‹¨ë…ìœ¼ë¡œ ì‚¬ìš©í•˜ëŠ” ê²½ìš°ëŠ” ì—†ê¸° ë•Œë¬¸ì— abstract classë¡œ êµ¬í˜„

<br>
<br>

## **ì¡°ì¸ ì „ëµ**

<br>

- ê°€ì¥ ê¶Œì¥í•˜ëŠ” ë°©ì‹
- Itemì— `@Inheritance(strategy = InheritanceType.JOINED)`
- ë¶€ëª¨ í´ë˜ìŠ¤ì— `@DiscriminatorColumn` ì¶”ê°€í•˜ì—¬ DTYPE ì¶”ê°€
    
    >ğŸ’¡ `@DiscriminatorColumn`
    >
    >- ê¸°ë³¸ì ìœ¼ë¡œ í•˜ìœ„ í…Œì´ë¸”ëª…ì´ ë“¤ì–´ê°
    >- ê°’ì„ ë°”ê¿”ì£¼ë ¤ë©´ ìì‹ í´ë˜ìŠ¤ì— `@DiscriminatorValue("<ì›í•˜ëŠ” ê°’>")`
    >- Columnëª… DTYPEì´ ê¸°ë³¸ì´ì§€ë§Œ, ë³€ê²½í•˜ë ¤ë©´ name ì´ìš©
    >- ìš´ì˜/DB ì‘ì—…ì„ ê³ ë ¤í•˜ì˜€ì„ ë•Œ ë„£ëŠ” ê²ƒì„ ê¶Œì¥
    
    

![]({{ site.url }}{{ site.baseurl }}/assets/images/jpa/lecture/orm/07/02.png ){: .align-center}

```java
@Entity
@Inheritance(strategy = InheritanceType.JOINED)
public class Item {

    @Id @GeneratedValue
    private Long id;

    private String name;
    private int price;

	// getter, setter

}
```

```java
@Entity
public class Album extends Item {

    private String artist;

	// getter, setter

}
```

```java
@Entity
public class Movie extends Item {

    private String director;
    private String actor;

	// getter, setter

}
```

```java
@Entity
public class Book extends Item {

    private String author;
    private String isbn;

	// getter, setter

}
```

ì‹¤í–‰ ê²°ê³¼ : Album, Book, Movie table ê°ê°ì´ Item tableì„ ì°¸ì¡°

```java
Hibernate: 
    
    create table Album (
       artist varchar(255),
        id bigint not null,
        primary key (id)
    )
Hibernate: 
    
    create table Book (
       author varchar(255),
        isbn varchar(255),
        id bigint not null,
        primary key (id)
    )
Hibernate: 
    
    create table Item (
       id bigint not null,
        name varchar(255),
        price integer not null,
        primary key (id)
    )
Hibernate: 
    
    create table Movie (
       actor varchar(255),
        director varchar(255),
        id bigint not null,
        primary key (id)
    )
Hibernate: 
    
    alter table Album 
       add constraint FKcve1ph6vw9ihye8rbk26h5jm9 
       foreign key (id) 
       references Item
Hibernate: 
    
    alter table Book 
       add constraint FKbwwc3a7ch631uyv1b5o9tvysi 
       foreign key (id) 
       references Item
Hibernate: 
    
    alter table Movie 
       add constraint FK5sq6d5agrc34ithpdfs0umo9g 
       foreign key (id) 
       references Item
```

Insert

```java
// ìƒëµ

Movie movie = new Movie();
movie.setDirector("aaa");
movie.setActor("bbb");
movie.setName("ë°”ëŒê³¼í•¨ê¼ì‚¬ë¼ì§€ë‹¤");
movie.setPrice(10000);

em.persist(movie);

tx.commit();

// ìƒëµ

```

DB

Item

| ID | NAME | PRICE |
| --- | --- | --- |
| 1 | ë°”ëŒê³¼í•¨ê»˜ì‚¬ë¼ì§€ë‹¤ | 10000 |

Movie

| ACTOR | DIRECTOR | ID |
| --- | --- | --- |
| bbb | aaa | 1 |

Select : Join í•˜ì—¬ ê°€ì ¸ì˜´

```java
// ìƒëµ

Movie movie = new Movie();
movie.setDirector("aaa");
movie.setActor("bbb");
movie.setName("ë°”ëŒê³¼í•¨ê¼ì‚¬ë¼ì§€ë‹¤");
movie.setPrice(10000);

em.persist(movie);

// 1ì°¨ ìºì‹œ ì•ˆë‚¨ë„ë¡ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ ì œê±°
em.flush();
em.clear();

Movie findMovie = em.find(Movie.class, movie.getId());
System.out.println("findMovie = " + findMovie);

tx.commit();

// ìƒëµ
```

ì‹¤í–‰ê²°ê³¼

```java
Hibernate: 
    select
        movie0_.id as id1_2_0_,
        movie0_1_.name as name2_2_0_,
        movie0_1_.price as price3_2_0_,
        movie0_.actor as actor1_3_0_,
        movie0_.director as director2_3_0_ 
    from
        Movie movie0_ 
    inner join
        Item movie0_1_ 
            on movie0_.id=movie0_1_.id 
    where
        movie0_.id=?
findMovie = hellojpa.Movie@4c7a078
```

- Itemì— DTYPE ì¶”ê°€ : `@DiscriminatorColumn`

```java

@Entity
@Inheritance(strategy = InheritanceType.JOINED)
@DiscriminatorColumn
public class Item {

    @Id @GeneratedValue
    private Long id;

    private String name;
    private int price;

    // getter, setter

}
```


DB

Item

| DTYPE | ID | NAME | PRICE |
| --- | --- | --- | --- |
| Movie | 1 | ë°”ëŒê³¼í•¨ê»˜ì‚¬ë¼ì§€ë‹¤ | 10000 |


- ì¥/ë‹¨ì 
    
    
    | êµ¬ë¶„ | ìƒì„¸ |
    | --- | --- |
    | ì¥ì  | â€¢ í…Œì´ë¸” ì •ê·œí™”<br>â€¢ ì™¸ë˜ í‚¤ ì°¸ì¡° ë¬´ê²°ì„± ì œì•½ì¡°ê±´ í™œìš©ê°€ëŠ¥ : ITEM_ID í™œìš©<br>â€¢ ì €ì¥ê³µê°„ íš¨ìœ¨í™” : ì •ê·œí™” ë˜ì–´ ìˆìœ¼ë‹ˆê¹Œ |
    | ë‹¨ì  | â€¢ ì¡°íšŒì‹œ ì¡°ì¸ì„ ë§ì´ ì‚¬ìš©, ì„±ëŠ¥ ì €í•˜<br>â€¢ ì¡°íšŒ ì¿¼ë¦¬ê°€ ë³µì¡í•¨<br>â€¢ ë°ì´í„° ì €ì¥ì‹œ INSERT SQL 2ë²ˆ í˜¸ì¶œ |

<br>
<br>

## **ë‹¨ì¼ í…Œì´ë¸” ì „ëµ**

<br>

![]({{ site.url }}{{ site.baseurl }}/assets/images/jpa/lecture/orm/07/03.png ){: .align-center}


- í…Œì´ë¸” êµ¬ë¶„ ì—†ì´ í•œ í…Œì´ë¸”ì— ëª¨ë“  ë°ì´í„°ë¥¼ ë„£ê³ , DTYPEìœ¼ë¡œ êµ¬ë¶„
- Itemì— `@Inheritance(strategy = InheritanceType.*SINGLE_TABLE*)`

```java
@Entity
@Inheritance(strategy = InheritanceType.SINGLE_TABLE)
@DiscriminatorColumn
public class Item {

    @Id @GeneratedValue
    private Long id;

    private String name;
    private int price;

    // getter, setter
}
```

```java
@Entity
@DiscriminatorValue("A")
public class Album extends Item {

    private String artist;

    public String getArtist() {
        return artist;
    }

    public void setArtist(String artist) {
        this.artist = artist;
    }
}
```

```java
@Entity
@DiscriminatorValue("B")
public class Book extends Item {

    private String author;
    private String isbn;

    // getter, setter
}
```

```java
@Entity
@DiscriminatorValue("M")
public class Movie extends Item {

    private String director;
    private String actor;

    // getter, setter
}
```

ì‹¤í–‰ ê²°ê³¼

```java
Hibernate: 
    
    create table Item (
       DTYPE varchar(31) not null,
        id bigint not null,
        name varchar(255),
        price integer not null,
        artist varchar(255),
        author varchar(255),
        isbn varchar(255),
        actor varchar(255),
        director varchar(255),
        primary key (id)
    )
```

- `@DiscriminatorColumn`ì„ ì„¤ì •í•´ì£¼ì§€ ì•Šì•„ë„ DTYPE ìƒì„±ë¨
    
    ```java
    @Entity
    @Inheritance(strategy = InheritanceType.SINGLE_TABLE)
    public class Item {
    
        @Id @GeneratedValue
        private Long id;
    
        private String name;
        private int price;
    
        // getter, setter
    }
    ```
    
    ```java
    package hellojpa;
    
    import javax.persistence.Entity;
    
    @Entity
    public class Album extends Item {
    
        // ìƒëµ
    }
    ```
    
    ```java
    package hellojpa;
    
    import javax.persistence.Entity;
    
    @Entity
    public class Book extends Item {
    
        // ìƒëµ
    }
    ```
    
    ```java
    
    @Entity
    public class Movie extends Item {
    
        // ìƒëµ
    }
    ```
    
    ì‹¤í–‰ ê²°ê³¼
    
    ```java
    create table Item (
           DTYPE varchar(31) not null,
            id bigint not null,
            name varchar(255),
            price integer not null,
            artist varchar(255),
            author varchar(255),
            isbn varchar(255),
            actor varchar(255),
            director varchar(255),
            primary key (id)
        )
    ```
    

- ì¥ì 
    - ì¡°ì¸ì´ í•„ìš” ì—†ìœ¼ë¯€ë¡œ ì¼ë°˜ì ìœ¼ë¡œ ì¡°íšŒ ì„±ëŠ¥ì´ ë¹ ë¦„
        - Insert í•  ë•Œë„ ì¿¼ë¦¬ í•œ ë²ˆ, ì¡°íšŒí•  ë•Œë„ Join X
            
            ```java
            Hibernate: 
                /* insert hellojpa.Movie
                    */ insert 
                    into
                        Item
                        (name, price, actor, director, DTYPE, id) 
                    values
                        (?, ?, ?, ?, 'M', ?)
            Hibernate: 
                select
                    movie0_.id as id2_0_0_,
                    movie0_.name as name3_0_0_,
                    movie0_.price as price4_0_0_,
                    movie0_.actor as actor8_0_0_,
                    movie0_.director as director9_0_0_ 
                from
                    Item movie0_ 
                where
                    movie0_.id=? 
                    and movie0_.DTYPE='M'
            findMovie = hellojpa.Movie@28f8e165
            ```
            
    - ì¡°íšŒ ì¿¼ë¦¬ê°€ ë‹¨ìˆœí•¨
- ë‹¨ì 
    - ìì‹ ì—”í‹°í‹°ê°€ ë§¤í•‘í•œ ì»¬ëŸ¼ì€ ëª¨ë‘ null í—ˆìš© : ë°ì´í„° ë¬´ê²°ì„± ê´€ì ì—ì„œ ë‹¨ì 
    - ë‹¨ì¼ í…Œì´ë¸”ì— ëª¨ë“  ê²ƒì„ ì €ì¥í•˜ë¯€ë¡œ í…Œì´ë¸”ì´ ì»¤ì§€ë©´ ìƒí™©ì— ë”°ë¼ì„œ ì¡°íšŒ ì„±ëŠ¥ì´ ì˜¤íˆë ¤ ëŠë ¤ì§ˆ ìˆ˜ ìˆìŒ
  
<br>
<br>

## **êµ¬í˜„ í´ë˜ìŠ¤ë§ˆë‹¤ í…Œì´ë¸” ì „ëµ**

<br>

- ì‚¬ìš©í•˜ì§€ ë§ ê²ƒ

![]({{ site.url }}{{ site.baseurl }}/assets/images/jpa/lecture/orm/07/04.png ){: .align-center}

- Item table ì—†ì´ ê°ê° í…Œì´ë¸”ì„ ë§Œë“¦ -> Name, Price Column ì¤‘ë³µ í—ˆìš©
- Itemì— `@Inheritance(strategy = InheritanceType.*TABLE_PER_CLASS*)`

```java
@Entity
@Inheritance(strategy = InheritanceType.TABLE_PER_CLASS)
@DiscriminatorColumn // ë„£ì–´ë„ ì˜ë¯¸ ì—†ìŒ
public abstract class Item {

    @Id @GeneratedValue
    private Long id;

    private String name;
    private int price;

    // getter, setter
}
```

```java
@Entity
public class Album extends Item {

    private String artist;

    // getter, setter

}
```

```java
@Entity
public class Book extends Item {

    private String author;
    private String isbn;

    // getter, setter
}
```

```java
@Entity
public class Movie extends Item {

    private String director;
    private String actor;

    // getter, setter
}
```

ì‹¤í–‰ê²°ê³¼ : Item tableì´ ìƒì„±ë˜ì§€ ì•ŠìŒ

```java
Hibernate: 
    
    create table Album (
       id bigint not null,
        name varchar(255),
        price integer not null,
        artist varchar(255),
        primary key (id)
    )
Hibernate: 
    
    create table Book (
       id bigint not null,
        name varchar(255),
        price integer not null,
        author varchar(255),
        isbn varchar(255),
        primary key (id)
    )
Hibernate: 
    
    create table Movie (
       id bigint not null,
        name varchar(255),
        price integer not null,
        actor varchar(255),
        director varchar(255),
        primary key (id)
    )
```

Insert/Select

```java
Hibernate: 
    /* insert hellojpa.Movie
        */ insert 
        into
            Movie
            (name, price, actor, director, id) 
        values
            (?, ?, ?, ?, ?)
Hibernate: 
    select
        movie0_.id as id1_2_0_,
        movie0_.name as name2_2_0_,
        movie0_.price as price3_2_0_,
        movie0_.actor as actor1_3_0_,
        movie0_.director as director2_3_0_ 
    from
        Movie movie0_ 
    where
        movie0_.id=?
findMovie = hellojpa.Movie@589b028e
```

- ë¬¸ì œì  : ë°ì´í„°ë¥¼ ì¡°íšŒí•  ë•Œ ë¶€ëª¨í…Œì´ë¸”ì¸ Itemìœ¼ë¡œ ì¡°íšŒí•œë‹¤ë©´ ..?
    
    -> union all ë¡œ ëª¨ë“  í…Œì´ë¸”ì„ ë‹¤ í™•ì¸ (InsertëŠ” ê´œì°®ìŒ)
    
    ```java
    // ìƒëµ
    Movie movie = new Movie();
    movie.setDirector("aaa");
    movie.setActor("bbb");
    movie.setName("ë°”ëŒê³¼í•¨ê¼ì‚¬ë¼ì§€ë‹¤");
    movie.setPrice(10000);
    
    em.persist(movie);
    
    // 1ì°¨ ìºì‹œ ì•ˆë‚¨ë„ë¡ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ ì œê±°
    em.flush();
    em.clear();
    
    Item item = em.find(Item.class, movie.getId());
    System.out.println("findItem = " + item);
    
    tx.commit();

    // ìƒëµ

    ```
    
    ```java
    Hibernate: 
        call next value for hibernate_sequence
    Hibernate: 
        /* insert hellojpa.Movie
            */ insert 
            into
                Movie
                (name, price, actor, director, id) 
            values
                (?, ?, ?, ?, ?)
    Hibernate: 
        select
            item0_.id as id1_2_0_,
            item0_.name as name2_2_0_,
            item0_.price as price3_2_0_,
            item0_.artist as artist1_0_0_,
            item0_.author as author1_1_0_,
            item0_.isbn as isbn2_1_0_,
            item0_.actor as actor1_3_0_,
            item0_.director as director2_3_0_,
            item0_.clazz_ as clazz_0_ 
        from
            ( select
                id,
                name,
                price,
                artist,
                null as author,
                null as isbn,
                null as actor,
                null as director,
                1 as clazz_ 
            from
                Album 
            union
            all select
                id,
                name,
                price,
                null as artist,
                author,
                isbn,
                null as actor,
                null as director,
                2 as clazz_ 
            from
                Book 
            union
            all select
                id,
                name,
                price,
                null as artist,
                null as author,
                null as isbn,
                actor,
                director,
                3 as clazz_ 
            from
                Movie 
        ) item0_ 
    where
        item0_.id=?
    findItem = hellojpa.Movie@53cdecf6
    ```
    
- ì¥/ë‹¨ì 
    
    
    | êµ¬ë¶„ | ìƒì„¸ |
    | --- | --- |
    | ì¥ì  | â€¢ ì„œë¸Œ íƒ€ì…ì„ ëª…í™•í•˜ê²Œ êµ¬ë¶„í•´ì„œ ì²˜ë¦¬í•  ë•Œ íš¨ê³¼ì  <br>â€¢ not null ì œì•½ì¡°ê±´ ì‚¬ìš© ê°€ëŠ¥ : í…Œì´ë¸”ì„ ë”°ë¡œ ìƒì„±í•˜ì˜€ìœ¼ë¯€ë¡œ |
    | ë‹¨ì  | â€¢ ì—¬ëŸ¬ ìì‹ í…Œì´ë¸”ì„ í•¨ê»˜ ì¡°íšŒí•  ë•Œ ì„±ëŠ¥ì´ ëŠë¦¼(UNION SQL í•„ìš”)<br>â€¢ ìì‹ í…Œì´ë¸”ì„ í†µí•©í•´ì„œ ì¿¼ë¦¬í•˜ê¸° ì–´ë ¤ì›€<br>â€¢ ë³€ê²½í•  ë•Œ ë§ì€ ê²ƒì„ ìˆ˜ì •í•´ì•¼ í•¨ |

<br>
<br>