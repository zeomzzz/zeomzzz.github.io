---
title:  "[자바 ORM 표준 JPA 프로그래밍 - 기본편] 04강. 엔티티 매핑"
excerpt: "수강 중"

categories:
  - JPA
tags:
  - [Framework, Lecture, JPA]

toc: true
toc_sticky: true
 
date: 2023-06-11
last_modified_at: 2023-06-11
---

<br>

# **04강. 엔티티 매핑**

<br>

## **0. 엔티티 매핑 소개**

<br>

- 객체와 테이블 매핑: `@Entity`, `@Table`
- 필드와 컬럼 매핑: `@Column`
- 기본 키 매핑: `@Id`
- 연관관계 매핑: `@ManyToOne`, `@JoinColumn`
    - ex. 회원 - 소속 팀 연관 관계 매핑
    - 1:1, 1:N ..

<br>

## **1. 객체와 테이블 매핑**

<br>

### **@Entity**

<br>

- `@Entity`가 붙은 클래스 : JPA가 관리하는 엔티티(필수)
    - 데이터베이스 테이블과 매핑되는 클래스
    - 없으면 JPA와 관련 없음


> 🚨 **주의**
>
>- 기본 생성자 필수 (파라미터가 없는 public 또는 protected 생성자)
>    - JPA 구현해서 사용하는 라이브러리를 사용하려면 필요
>- final 클래스, enum, interface, inner 클래스 사용X
>- DB에 저장할 필드에 final 사용 X

<br>
<br>

### **@Table**

<br>

- `@Table` : 엔티티와 매핑할 테이블 지정


| 속성 | 기능 | 기본값 |
| --- | --- | --- |
| name | 매핑할 테이블 이름 | 엔티티 이름 그대로 사용
(같은 클래스 이름 없으면 가급적 기본값 사용) |
| catalog | 데이터베이스 catalog 매핑 |  |
| schema | 데이터베이스 schema 매핑 |  |
| uniqueConstraints (DDL) | DDL 생성 시에 유니크 제약 조건 생성 |  |

- name : 다른 이름으로 지정하고 싶은 경우
    
    ```java
    @Entity
    @Table(name = "MBR") // MBR 테이블과 매핑
    public class Member {
    	...
    }
    ```

<br>    

## **2. 데이터베이스 스키마 자동 생성**

<br>

### **데이터베이스 스키마 자동 생성**

<br>

- 테이블 중심 -> 객체 중심
- DDL을 애플리케이션 실행 시점에 자동 생성 (CREATE)
    - 객체 매핑 알아서 해줌!
- 데이터베이스 방언을 활용해서 데이터베이스에 맞는 적절한 DDL 생성
- 이렇게 생성된 DDL은 개발 장비에서만 사용
    - 운영서버에서는 사용하지 않거나, 필요하다면 적절히 다듬은 후 사용

<br>

#### **1) 속성**

<br>

- `hibernate.hbm2ddl.auto`

| 옵션 | 설명 |
| --- | --- |
| create | - 기존테이블 삭제 후 생성 (DROP + CREATE) |
| create-drop | - create와 같으나 종료시점에 테이블 DROP <br> - 보통 TC 실행해볼 때, 마지막에 지우기 위해 사용 |
| update | - 변경분만 반영(운영DB에는 사용하면 안됨)
<br>
- 테이블 변경하는데 Drop 하지 않고 Alter 하고 싶을 때 사용
<br>
- 삭제는 안되고 추가만 가능 |
| validate | - 엔티티와 테이블이 정상 매핑되었는지만 확인 |
| none | - 속성을 사용하지 않음 |

<br>

ex. create

persistence.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<persistence version="2.2"
             xmlns="http://xmlns.jcp.org/xml/ns/persistence" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
             xsi:schemaLocation="http://xmlns.jcp.org/xml/ns/persistence http://xmlns.jcp.org/xml/ns/persistence/persistence_2_2.xsd">
    <persistence-unit name="hello">
        <properties>
            <!-- 필수 속성 -->
            <property name="javax.persistence.jdbc.driver" value="org.h2.Driver"/>
            <property name="javax.persistence.jdbc.user" value="sa"/>
            <property name="javax.persistence.jdbc.password" value=""/>
            <property name="javax.persistence.jdbc.url" value="jdbc:h2:tcp://localhost/~/test"/>
            <property name="hibernate.dialect" value="org.hibernate.dialect.H2Dialect"/>
            <!-- 옵션 -->
            <property name="hibernate.show_sql" value="true"/>
            <property name="hibernate.format_sql" value="true"/>
            <property name="hibernate.use_sql_comments" value="true"/>
            <property name="hibernate.jdbc.batch_size" value="10"/>
            <property name="hibernate.hbm2ddl.auto" value="create" />
        </properties>
    </persistence-unit>
</persistence>
```

Member.java

```java
package hellojpa;

import javax.persistence.Entity;
import javax.persistence.Id;

@Entity
public class Member {

    @Id // PK
    private long id;
    private String name;
    private int age;

    // 생성자 (기본 생성자 꼭!!)
    // 생략

    // getter, setter
    // 생략
}
```

JpaMain.java 실행 결과 : Drop Table 후에 Create Table + DB에 데이터 없는 빈 테이블 생성됨

```java
Hibernate: 
    
    drop table Member if exists

Hibernate: 
    
    create table Member (
       id bigint not null,
        age integer not null,
        name varchar(255),
        primary key (id)
    )
```

ex. update

persistence.xml

```java
<?xml version="1.0" encoding="UTF-8"?>
<persistence version="2.2"
             xmlns="http://xmlns.jcp.org/xml/ns/persistence" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
             xsi:schemaLocation="http://xmlns.jcp.org/xml/ns/persistence http://xmlns.jcp.org/xml/ns/persistence/persistence_2_2.xsd">
    <persistence-unit name="hello">
        <properties>
            <!-- 필수 속성 -->
            <property name="javax.persistence.jdbc.driver" value="org.h2.Driver"/>
            <property name="javax.persistence.jdbc.user" value="sa"/>
            <property name="javax.persistence.jdbc.password" value=""/>
            <property name="javax.persistence.jdbc.url" value="jdbc:h2:tcp://localhost/~/test"/>
            <property name="hibernate.dialect" value="org.hibernate.dialect.H2Dialect"/>
            <!-- 옵션 -->
            <property name="hibernate.show_sql" value="true"/>
            <property name="hibernate.format_sql" value="true"/>
            <property name="hibernate.use_sql_comments" value="true"/>
            <property name="hibernate.jdbc.batch_size" value="10"/>
            <property name="hibernate.hbm2ddl.auto" value="update" />
        </properties>
    </persistence-unit>
</persistence>
```

Member.java

```java
package hellojpa;

import javax.persistence.Entity;
import javax.persistence.Id;

@Entity
public class Member {

    @Id // PK
    private long id;
    private String name;

    // 생성자 (기본 생성자 꼭!!)
    // 생략

    // getter, setter
    // 생략
}
```

실행 결과

```java
Hibernate: 
    
    create table Member (
       id bigint not null,
        name varchar(255),
        primary key (id)
    )
```

Member.java에 age 추가 후 다시 실행

Member.java

```java
package hellojpa;

import javax.persistence.Entity;
import javax.persistence.Id;

@Entity
public class Member {

    @Id // PK
    private long id;
    private String name;
		private int age;

    // 생성자 (기본 생성자 꼭!!)
    // 생략

    // getter, setter
    // 생략
}
```

실행 결과 : age column만 alter

```java
Hibernate: 
    
    alter table Member 
       add column age integer not null
```

ex. validate

persistence.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<persistence version="2.2"
             xmlns="http://xmlns.jcp.org/xml/ns/persistence" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
             xsi:schemaLocation="http://xmlns.jcp.org/xml/ns/persistence http://xmlns.jcp.org/xml/ns/persistence/persistence_2_2.xsd">
    <persistence-unit name="hello">
        <properties>
            <!-- 필수 속성 -->
            <property name="javax.persistence.jdbc.driver" value="org.h2.Driver"/>
            <property name="javax.persistence.jdbc.user" value="sa"/>
            <property name="javax.persistence.jdbc.password" value=""/>
            <property name="javax.persistence.jdbc.url" value="jdbc:h2:tcp://localhost/~/test"/>
            <property name="hibernate.dialect" value="org.hibernate.dialect.H2Dialect"/>
            <!-- 옵션 -->
            <property name="hibernate.show_sql" value="true"/>
            <property name="hibernate.format_sql" value="true"/>
            <property name="hibernate.use_sql_comments" value="true"/>
            <property name="hibernate.jdbc.batch_size" value="10"/>
            <property name="hibernate.hbm2ddl.auto" value="validate" />
        </properties>
    </persistence-unit>
</persistence>
```

Member.java

```java
package hellojpa;

import javax.persistence.Entity;
import javax.persistence.Id;

@Entity
public class Member {

    @Id // PK
    private long id;
    private String name;
		private int gogo; // table에 없는 컬럼

    // 생성자 (기본 생성자 꼭!!)
    // 생략

    // getter, setter
    // 생략
}
```

실행 결과(에러)

```xml
Caused by: org.hibernate.tool.schema.spi.SchemaManagementException: Schema-validation: missing column [gogo] in table [Member]
```

<br>

#### **2) 실습**

<br>

- 스키마 자동 생성하기 설정
- 스키마 자동생성하기 실행, 옵션별 확인
- 데이터베이스 방언 별로 달라지는 것 확인(varchar)
    
    ex. Oracle
    
    persistence.xml
    
    ```xml
    <?xml version="1.0" encoding="UTF-8"?>
    <persistence version="2.2"
                 xmlns="http://xmlns.jcp.org/xml/ns/persistence" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                 xsi:schemaLocation="http://xmlns.jcp.org/xml/ns/persistence http://xmlns.jcp.org/xml/ns/persistence/persistence_2_2.xsd">
        <persistence-unit name="hello">
            <properties>
                <!-- 필수 속성 -->
                <property name="javax.persistence.jdbc.driver" value="org.h2.Driver"/>
                <property name="javax.persistence.jdbc.user" value="sa"/>
                <property name="javax.persistence.jdbc.password" value=""/>
                <property name="javax.persistence.jdbc.url" value="jdbc:h2:tcp://localhost/~/test"/>
                <property name="hibernate.dialect" value="org.hibernate.dialect.Oracle12cDialect"/>
                <!-- 옵션 -->
                <property name="hibernate.show_sql" value="true"/>
                <property name="hibernate.format_sql" value="true"/>
                <property name="hibernate.use_sql_comments" value="true"/>
                <property name="hibernate.jdbc.batch_size" value="10"/>
                <property name="hibernate.hbm2ddl.auto" value="create" />
            </properties>
        </persistence-unit>
    </persistence>
    ```
    
    실행결과 : varchar2 : Oracle 방언
    
    ```xml
    Hibernate: 
        
        create table Member (
           id number(19,0) not null,
            gogo number(10,0) not null,
            name varchar2(255 char),
            primary key (id)
        )
    ```
    

>🚨 **주의**
>
>- 운영 장비에는 절대 create, create-drop, update 사용하면 안됨!!!
>- 개발 초기 단계는 create 또는 update
>- 테스트 서버는 update 또는 validate
>- 스테이징과 운영 서버는 validate 또는 none
>- 혼자 쓰는 로컬 PC 아니면 가급적이면 사용하지 말기 : 필요하면 직접 script 써써 테스트

<br>

### **DDL 생성 기능**

<br>

- 제약조건 추가: 회원 이름은 필수, 10자 초과X
    - `@Column(nullable = false, length = 10)`
    
    ex. 
    
    Member.java
    
    ```java
    package hellojpa;
    
    import javax.persistence.Column;
    import javax.persistence.Entity;
    import javax.persistence.Id;
    
    @Entity
    public class Member {
    
        @Id // PK
        private long id;
        @Column(unique = true, length = 10)
        private String name;
        private int age;
    
    }
    ```
    
    실행 결과
    
    ```java
    Hibernate: 
        
        create table Member (
           id bigint not null,
            age integer not null,
            name varchar(10),
            primary key (id)
        )
    Hibernate: 
        
        alter table Member 
           add constraint UK_ektea7vp6e3low620iewuxhlq unique (name)
    ```
    
- 유니크 제약조건 추가
    - `@Table(uniqueConstraints = {@UniqueConstraint( name = "NAME_AGE_UNIQUE", columnNames = {"NAME", "AGE"})})`
- DDL 생성 기능은 DDL을 자동 생성할 때만 사용되고 JPA의 실행 로직에는 영향을 주지 않는다